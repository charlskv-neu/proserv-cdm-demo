trigger:
  branches:
   include:
     - release
     - development
   exclude:
     - master
     - feature/*


variables:
  - name: PoolImage
    value: 'vs2017-win2016'
  - name: BuildJobDisplayName
    value: 'ProServ Demo Build'

 #deployment variables
    #DEV Environment
  - name: StageName_Dev
    value: 'Dev'
  - name: StageDisplayName_Dev
    value: 'Dev'
  - name: EnvironmentName_Dev
    value: 'ProServ-Dev'
  - name: VariableGroup_Dev
    value: 'Proserv-CDM-Demo-Variables'

 #Test variables
    #Test Environment
  - name: StageName_Test
    value: 'Test'
  - name: StageDisplayName_Test
    value: 'Test'
  - name: EnvironmentName_Test
    value: 'ProServ-Test'
  - name: VariableGroup_Test
    value: 'Proserv-CDM-Demo-Variables'

 #Production variables
    #Prod Environment
  - name: StageName_Prod
    value: 'Prod'
  - name: StageDisplayName_Prod
    value: 'Prod'
  - name: EnvironmentName_Prod
    value: 'ProServ-Prod'
  - name: VariableGroup_Prod
    value: 'Proserv-CDM-Demo-Variables'


stages:
- stage: Build
  jobs:
  - template: YamlTemplates/jobs/build/infra-code-build.yml
    parameters:
      PoolImage: $(PoolImage)
      BuildJobDisplayName: '${{variables.BuildJobDisplayName}}'

- stage: ${{variables.StageName_Dev}}
  displayName: ${{variables.StageDisplayName_Dev}}
  #condition: and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/heads/development'))
  dependsOn: Build
  variables:
    - group: ${{variables.VariableGroup_Dev}}
  jobs:
  - template: YamlTemplates/jobs/release/infra-code-release.yml
    parameters:
      StageName: ${{variables.StageName_Dev}}
      EnvironmentName: ${{variables.EnvironmentName_Dev}}
      PoolImage: $(PoolImage)

- stage: ${{variables.StageName_Test}}
  displayName: ${{variables.StageDisplayName_Test}}
  condition: and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/heads/Release'))
  dependsOn: Build
  variables:
    - group: ${{variables.VariableGroup_Test}}
  jobs:
  - template: YamlTemplates/jobs/release/infra-code-release.yml
    parameters:
      StageName: ${{variables.StageName_Test}}
      EnvironmentName: ${{variables.EnvironmentName_Test}}
      PoolImage: $(PoolImage)

- stage: ${{variables.StageName_Prod}}
  displayName: ${{variables.StageDisplayName_Prod}}
  condition: and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/heads/Release'))
  dependsOn: ${{variables.StageName_Test}}
  variables:
    - group: ${{variables.VariableGroup_Prod}}
  jobs:
  - template: YamlTemplates/jobs/release/infra-code-release.yml
    parameters:
      StageName: ${{variables.StageName_Prod}}
      EnvironmentName: ${{variables.EnvironmentName_Prod}}
      PoolImage: $(PoolImage)
