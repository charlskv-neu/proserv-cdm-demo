{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "sipdemosynws"
		},
		"AzureDataLakeStorageDemo_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://sipdemosa.dfs.core.windows.net"
		},
		"adls_cdm_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://sipdemosa.dfs.core.windows.net"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/GeneralLedger_CDM')]",
			"type": "Microsoft.Synapse/workspaces/pipelines",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"activities": [
					{
						"name": "Dynamics_Dataflow",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "DynamicsGL_CDM",
								"type": "DataFlowReference",
								"parameters": {
									"CorpusContainer": {
										"value": "'@{pipeline().parameters.CorpusContainer}'",
										"type": "Expression"
									},
									"CorpusFolder": {
										"value": "'@{pipeline().parameters.CorpusFolder}'",
										"type": "Expression"
									},
									"RootContainer": {
										"value": "'@{pipeline().parameters.RootContainer}'",
										"type": "Expression"
									},
									"RootFolder": {
										"value": "'@{pipeline().parameters.RootFolder}'",
										"type": "Expression"
									},
									"Entity": {
										"value": "'@{pipeline().parameters.Entity}'",
										"type": "Expression"
									},
									"ManifestEntityPath": {
										"value": "'@{pipeline().parameters.ManifestEntityPath}'",
										"type": "Expression"
									},
									"ManifestName": {
										"value": "'@{pipeline().parameters.ManifestName}'",
										"type": "Expression"
									}
								},
								"datasetParameters": {
									"source1": {
										"FileSystem": {
											"value": "@pipeline().parameters.FileSystem",
											"type": "Expression"
										},
										"FileName": {
											"value": "@pipeline().parameters.FileName",
											"type": "Expression"
										},
										"SheetName": {
											"value": "@pipeline().parameters.SheetName",
											"type": "Expression"
										}
									},
									"sink1": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"parameters": {
					"FileSystem": {
						"type": "string",
						"defaultValue": "crmdynamics"
					},
					"FileName": {
						"type": "string",
						"defaultValue": "General Journal.xlsx"
					},
					"CorpusContainer": {
						"type": "string",
						"defaultValue": "models"
					},
					"CorpusFolder": {
						"type": "string",
						"defaultValue": "cdm"
					},
					"RootContainer": {
						"type": "string",
						"defaultValue": "models"
					},
					"RootFolder": {
						"type": "string",
						"defaultValue": "data"
					},
					"Entity": {
						"type": "string",
						"defaultValue": "GeneralJournal.cdm.json/GeneralJournal"
					},
					"ManifestEntityPath": {
						"type": "string"
					},
					"ManifestName": {
						"type": "string",
						"defaultValue": "GeneralLedger"
					},
					"SheetName": {
						"type": "string",
						"defaultValue": "General_journal"
					}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/dataflows/DynamicsGL_CDM')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/DynamicsGeneralJournalExcel')]",
			"type": "Microsoft.Synapse/workspaces/datasets",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"linkedServiceName": {
					"referenceName": "AzureDataLakeStorageDemo",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"FileSystem": {
						"type": "string",
						"defaultValue": "crmdynamics"
					},
					"FileName": {
						"type": "string",
						"defaultValue": "General Journal.xlsx"
					},
					"SheetName": {
						"type": "string",
						"defaultValue": "General_journal"
					}
				},
				"annotations": [],
				"type": "Excel",
				"typeProperties": {
					"sheetName": {
						"value": "@dataset().SheetName",
						"type": "Expression"
					},
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": {
							"value": "@dataset().FileName",
							"type": "Expression"
						},
						"fileSystem": {
							"value": "@dataset().FileSystem",
							"type": "Expression"
						}
					},
					"firstRowAsHeader": true
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/linkedServices/AzureDataLakeStorageDemo')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AzureDataLakeStorageDemo')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('AzureDataLakeStorageDemo_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/adls_cdm')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('adls_cdm_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/DynamicsGL_CDM')]",
			"type": "Microsoft.Synapse/workspaces/dataflows",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "DynamicsGeneralJournalExcel",
								"type": "DatasetReference"
							},
							"name": "source1"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "adls_cdm",
								"type": "LinkedServiceReference"
							},
							"schemaLinkedService": {
								"referenceName": "adls_cdm",
								"type": "LinkedServiceReference"
							},
							"name": "sink1"
						}
					],
					"transformations": [],
					"script": "parameters{\n\tCorpusContainer as string,\n\tCorpusFolder as string,\n\tRootContainer as string,\n\tRootFolder as string,\n\tEntity as string,\n\tManifestEntityPath as string,\n\tManifestName as string\n}\nsource(output(\n\t\tJOURNALBATCHNUMBER as short,\n\t\tLINENUMBER as short,\n\t\tACCOUNTDISPLAYVALUE as string,\n\t\tACCOUNTTYPE as string,\n\t\tCASHDISCOUNT as string,\n\t\tCASHDISCOUNTAMOUNT as string,\n\t\tCASHDISCOUNTDATE as string,\n\t\tCREDITAMOUNT as double,\n\t\tCURRENCYCODE as string,\n\t\tDEBITAMOUNT as double,\n\t\tDEFAULTDIMENSIONDISPLAYVALUE as string,\n\t\tDESCRIPTION as string,\n\t\tDOCUMENT as string,\n\t\tDUEDATE as string,\n\t\tEXCHANGERATE as double,\n\t\tEXCHANGERATESECONDARY as double,\n\t\tINVOICE as string,\n\t\tISPOSTED as boolean,\n\t\tITEMSALESTAXGROUP as string,\n\t\tJOURNALNAME as string,\n\t\tOFFSETACCOUNTDISPLAYVALUE as string,\n\t\tOFFSETACCOUNTTYPE as string,\n\t\tOFFSETDEFAULTDIMENSIONDISPLAYVALUE as string,\n\t\tOFFSETTEXT as string,\n\t\tPAYMENTID as string,\n\t\tPAYMENTMETHOD as string,\n\t\tPAYMENTREFERENCE as string,\n\t\tPOSTINGLAYER as string,\n\t\tPOSTINGPROFILE as string,\n\t\tQUANTITY as double,\n\t\tSALESTAXCODE as string,\n\t\tSALESTAXGROUP as string,\n\t\tTAXEXEMPTNUMBER as string,\n\t\tTEXT as string,\n\t\tTRANSDATE as date,\n\t\tVOUCHER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> source1\nsource1 sink(allowSchemaDrift: false,\n\tvalidateSchema: false,\n\tinput(\n\t\tJournalName as string,\n\t\tJournalBatchNumber as string,\n\t\tLineNumber as string,\n\t\tAccountName as string,\n\t\tAccountType as string,\n\t\tCreditAmount as string,\n\t\tDebitAmount as string,\n\t\tCurrency as string,\n\t\tExchangeRate as string,\n\t\tDescription as string,\n\t\tInvoice as string,\n\t\tIsPosted as string,\n\t\tPostedDate as string,\n\t\tPostingLayer as string,\n\t\tOffsetAccountName as string,\n\t\tOffsetAccountType as string,\n\t\tPaymentMethod as string,\n\t\tPaymentDate as string\n\t),\n\tentity: ($Entity),\n\tformat: 'cdm',\n\tmanifestType: 'manifest',\n\tentityPath: ($ManifestEntityPath),\n\tmanifestName: ($ManifestName),\n\tfolderPath: ($RootFolder),\n\tfileSystem: ($RootContainer),\n\tcolumnDelimiter: ',',\n\tcolumnNamesAsHeader: true,\n\tcorpusPath: ($CorpusFolder),\n\tcorpusStore: 'adlsgen2',\n\tadlsgen2_fileSystem: ($RootContainer),\n\ttruncate: false,\n\tmapColumn(\n\t\tJournalName = JOURNALNAME,\n\t\tJournalBatchNumber = JOURNALBATCHNUMBER,\n\t\tLineNumber = LINENUMBER,\n\t\tAccountName = ACCOUNTDISPLAYVALUE,\n\t\tAccountType = ACCOUNTTYPE,\n\t\tCreditAmount = CREDITAMOUNT,\n\t\tDebitAmount = DEBITAMOUNT,\n\t\tCurrency = CURRENCYCODE,\n\t\tExchangeRate = EXCHANGERATE,\n\t\tDescription = DESCRIPTION,\n\t\tInvoice = INVOICE,\n\t\tIsPosted = ISPOSTED,\n\t\tPostedDate = DUEDATE,\n\t\tPostingLayer = POSTINGLAYER,\n\t\tOffsetAccountName = OFFSETACCOUNTDISPLAYVALUE,\n\t\tOffsetAccountType = OFFSETACCOUNTTYPE,\n\t\tPaymentMethod = PAYMENTMETHOD,\n\t\tPaymentDate = TRANSDATE\n\t),\n\tpartitionBy('hash', 1),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sink1"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/datasets/DynamicsGeneralJournalExcel')]",
				"[concat(variables('workspaceId'), '/linkedServices/adls_cdm')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WorkspaceSystemIdentity')]",
			"type": "Microsoft.Synapse/workspaces/credentials",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "ManagedIdentity",
				"typeProperties": {}
			},
			"dependsOn": []
		}
	]
}